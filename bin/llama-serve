#!/usr/bin/env bash
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"
REPO_DIR="$SCRIPT_DIR/.."
source "$REPO_DIR/env.sh"
BINARY="$REPO_DIR/ipex-llm/llama-server-bin"
if [[ ! -x "$BINARY" ]]; then
    echo "[llama-serve] ERROR: $BINARY not found. Run setup.sh first." >&2
    exit 1
fi

# Build args: always enable --jinja for tool calling
ARGS=(--jinja)

# Apply model-specific chat template fixes if available
for arg in "$@"; do
    if [[ "$arg" == *.gguf ]]; then
        model_name="$(basename "$arg" .gguf)"
        # Check for a matching template fix
        for tmpl in "$REPO_DIR"/templates/*.jinja; do
            tmpl_name="$(basename "$tmpl" .jinja)"
            if [[ "$model_name" == *"$tmpl_name"* || "$tmpl_name" == *"$model_name"* ]]; then
                ARGS+=(--chat-template-file "$tmpl")
                break
            fi
        done
        break
    fi
done

exec "$BINARY" "${ARGS[@]}" "$@"
